workflows:
  android-workflow:
    name: Android Build
    max_build_duration: 60
    instance_type: mac_mini_m2
    environment:
      node: 16.13.0
      java: 17 
      vars:
        PACKAGE_NAME: "com.slivkishop.ru"
      groups:
        # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð¿Ñ€ÐµÐ´ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð½ÑƒÑŽ Ð³Ñ€ÑƒÐ¿Ð¿Ñƒ Ð´Ð»Ñ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ¸ Android-Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ð¹
        - Android code signing
    scripts:
      - name: Install dependencies
        script: |
          npm install -g cordova
          npm install
      
      - name: Setup Android SDK
        script: |
          echo "y" | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "build-tools;35.0.0" "platforms;android-35"
      
      - name: Setup Keystore
        script: |
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ keystore Ñ„Ð°Ð¹Ð»Ð°, ÐµÑÐ»Ð¸ Ð¾Ð½Ð° Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
          mkdir -p $(dirname "$KEYSTORE_PATH")
          
          # Ð”ÐµÐºÐ¾Ð´Ð¸Ñ€ÑƒÐµÐ¼ base64 Ð¸Ð· KEYSTORE_FILE Ð² Ð¿ÑƒÑ‚ÑŒ, ÑƒÐºÐ°Ð·Ð°Ð½Ð½Ñ‹Ð¹ Ð² KEYSTORE_PATH
          echo $KEYSTORE_FILE | base64 --decode > $KEYSTORE_PATH
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ñ„Ð°Ð¹Ð» keystore ÑÐ¾Ð·Ð´Ð°Ð½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾
          if [ -f "$KEYSTORE_PATH" ]; then
            echo "Keystore file successfully created at: $KEYSTORE_PATH"
            file $KEYSTORE_PATH
            ls -la $KEYSTORE_PATH
          else
            echo "ERROR: Failed to create keystore file at path: $KEYSTORE_PATH"
            exit 1
          fi
      
      - name: Add Android Platform
        script: |
          cordova platform add android@latest
      
      - name: Create Signing Configuration
        script: |
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ build.json Ñ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÐµÐ¹ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ¸ Ð´Ð»Ñ ÐžÐ‘ÐžÐ˜Ð¥ Ñ‚Ð¸Ð¿Ð¾Ð² ÑÐ±Ð¾Ñ€ÐºÐ¸
          cat > build.json << EOF
          {
            "android": {
              "debug": {
                "keystore": "$KEYSTORE_PATH",
                "storePassword": "$KEYSTORE_PASSWORD",
                "alias": "$KEY_ALIAS",
                "password": "$KEY_PASSWORD",
                "keystoreType": "jks"
              },
              "release": {
                "keystore": "$KEYSTORE_PATH",
                "storePassword": "$KEYSTORE_PASSWORD",
                "alias": "$KEY_ALIAS",
                "password": "$KEY_PASSWORD",
                "keystoreType": "jks"
              }
            }
          }
          EOF
          
          # Ð’Ñ‹Ð²Ð¾Ð´Ð¸Ð¼ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ build.json Ð´Ð»Ñ Ð¾Ñ‚Ð»Ð°Ð´ÐºÐ¸ (Ð±ÐµÐ· Ñ‡ÑƒÐ²ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…)
          echo "Build.json created with signing configuration for both debug and release builds"
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²Ð¾Ð²Ð°Ð½Ð¸Ðµ build.json
          if [ -f "build.json" ]; then
            echo "âœ… build.json ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½"
          else
            echo "âŒ ÐžÐ¨Ð˜Ð‘ÐšÐ: build.json Ð½Ðµ ÑÐ¾Ð·Ð´Ð°Ð½"
            exit 1
          fi
      
      - name: Build Debug APK
        script: |
          # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ build.json Ð´Ð»Ñ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ¸ debug ÑÐ±Ð¾Ñ€ÐºÐ¸ Ñ‚ÐµÐ¼ Ð¶Ðµ ÐºÐ»ÑŽÑ‡Ð¾Ð¼
          cordova build android --debug --buildConfig=build.json --verbose
      
      - name: Build Release APK and AAB
        script: |
          # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ build.json Ð´Ð»Ñ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ¸ release ÑÐ±Ð¾Ñ€ÐºÐ¸
          cordova build android --release --buildConfig=build.json --verbose
      
      - name: Display Build Output and Verification
        script: |
          echo "Debug APK:"
          ls -la platforms/android/app/build/outputs/apk/debug/ || echo "Debug APK directory not found"
          
          echo "Release APK:"
          ls -la platforms/android/app/build/outputs/apk/release/ || echo "Release APK directory not found"
          
          echo "Release Bundle (AAB):"
          ls -la platforms/android/app/build/outputs/bundle/release/ || echo "AAB directory not found"

          echo "ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹ gradle..."
          if [ -f "platforms/android/build/reports/problems/problems-report.html" ]; then
            echo "âœ… Problems report Ð½Ð°Ð¹Ð´ÐµÐ½: platforms/android/build/reports/problems/problems-report.html"
            echo "ðŸ“„ ÐšÑ€Ð°Ñ‚ÐºÐ¾Ðµ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð°:"
            head -10000 platforms/android/build/reports/problems/problems-report.html || echo "ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ñ‚ÑŒ Ð¾Ñ‚Ñ‡ÐµÑ‚"
          else
            echo "ÐžÑ‚Ñ‡Ñ‘Ñ‚ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
          fi 
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ¸ APK Ð´Ð»Ñ Ð´ÐµÐ±Ð°Ð³ Ð¸ Ñ€ÐµÐ»Ð¸Ð· Ð²ÐµÑ€ÑÐ¸Ð¹
          echo "Verifying APK signatures match:"
          if [ -f "platforms/android/app/build/outputs/apk/debug/app-debug.apk" ] && [ -f "platforms/android/app/build/outputs/apk/release/app-release.apk" ]; then
            DEBUG_SIGNATURE=$(keytool -printcert -jarfile platforms/android/app/build/outputs/apk/debug/app-debug.apk | grep "SHA256" | head -1)
            RELEASE_SIGNATURE=$(keytool -printcert -jarfile platforms/android/app/build/outputs/apk/release/app-release.apk | grep "SHA256" | head -1)
            
            echo "Debug signature: $DEBUG_SIGNATURE"
            echo "Release signature: $RELEASE_SIGNATURE"
            
            if [ "$DEBUG_SIGNATURE" = "$RELEASE_SIGNATURE" ]; then
              echo "âœ… Signatures match! APKs are signed with the same key."
            else
              echo "âŒ WARNING: Signatures don't match! Debug and release APKs are signed with different keys."
            fi
          else
            echo "Cannot verify signatures: one or both APK files not found"
          fi
    
    artifacts:
      - platforms/android/app/build/outputs/apk/debug/app-debug.apk
      - platforms/android/app/build/outputs/apk/release/app-release.apk
      - platforms/android/app/build/outputs/bundle/release/app-release.aab
      - platforms/android/build/reports/problems/problems-report.html
      - build.json
      - platforms/android/app/build/reports/**/*.html
    
    publishing:
      email:
        recipients:
          - user@example.com
      scripts:
        - name: Version Info
          script: |
            VERSION=$(grep -o 'version="[^"]*"' config.xml | cut -d'"' -f2)
            echo "Ð¡Ð¾Ð±Ñ€Ð°Ð½Ð° Ð²ÐµÑ€ÑÐ¸Ñ $VERSION Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ $PACKAGE_NAME"